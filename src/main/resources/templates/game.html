<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>The Binding of GAMJEON</title>

<link rel="stylesheet" type="text/css" href="css/common.css">

</head>
<body>
	
	<img id="item" width="140" height="20" src="img/item/item.png">
	<img id="info_inventory" width="105" height="70" src="img/info/inventory.png">

	<img id="room" width="540" height="420" src="img/sprite/room/room.png">
	<img id="floor" width="420" height="300" src="img/sprite/room/control_description.png">
	<img id="player" width="320" height="160" src="img/character/gamjeon.png">
	<img id="attack" width="20" height="20" src="img/character/weapon/default.png">
	<img id="bomb" width="40" height="40" src="img/sprite/bomb.png">
	
	<canvas id="info" width="540" height="80"></canvas>
	<canvas id="canvas" width="540" height="420"></canvas>
	
	<script type="text/javascript" src="js/monster.js"></script>
	<script th:inline="javascript">
		/*<![CDATA[*/
		var canvas = document.getElementById("canvas");
		var infoCanvas = document.getElementById("info");
		var ctx = canvas.getContext("2d");
		var ctx2 = infoCanvas.getContext("2d");
		const cw = canvas.width;
		const ch = canvas.height;

		var item = document.getElementById("item");
		var room = document.getElementById("room");
		var door = [null, null, null, null];
		var obstacle = [];
		var floor = document.getElementById("floor");
		var player = document.getElementById("player");
		var attack = document.getElementById("attack");
		var bomb = document.getElementById("bomb");
		
		var roomInfo = [];
		var roomNo = 0;
		var playerInfo;
		var bombInfo;
		
		var drawInterval;
		
		var wall = [60, 60, 60, 60]; // top, bottom, left, right
		var attacks = [];
		
		var pressed = [false, false, false, false]; // up, down, left, right
		
		var directionCode = 4;
		var attackDirection = 1;
		
		var controlFlag = true;
		var attackFlag = true;
		var bombFlag = true;
		
		var monster = [];
		
		document.addEventListener("keydown", keyDown, false);
		document.addEventListener("keyup", keyUp, false);
		
		window.onload = function() {
			init();
		};
		
		function keyDown(e) {
			var key = e.keyCode;
			
			if(!controlFlag) {
				return;
			}
			
			if(key==87) {
				pressed[0] = true;
			} else if(key==83) {
				pressed[1] = true;
			}
			
			if(key==65) {
				pressed[2] = true;
			} else if(key==68) {
				pressed[3] = true;
			}
			
			if(key==38) {
				attackSetting(0);
			}
			if(key==40) {
				attackSetting(1);
			}
			if(key==37) {
				attackSetting(2);
			}
			if(key==39) {
				attackSetting(3);
			}
			
			if(key==67 || key==16) {
				bombSetting(playerInfo.moveBox.x, playerInfo.moveBox.y);
			}
			
			if(key==70) {
				console.log("testFunction(playerInfo)");
				testFunction(playerInfo);
			}
		}

		function keyUp(e) {
			var key = e.keyCode;
			
			if(key==87) {
				pressed[0] = false;
			} else if(key==83) {
				pressed[1] = false;
			}
			
			if(key==65) {
				pressed[2] = false;
			} else if(key==68) {
				pressed[3] = false;
			}
		}
		
		function testFunction(obj) {
			obj.x += 10;
			obj.y += 10;
			
			objX = obj.x;
			objY = obj.y;
			pX = playerInfo.x;
			pY = playerInfo.y;
			
			console.log("objX: "+objX+", objY: "+objY);
			console.log("pX: "+pX+", pY: "+pY);
		}
		
		function init() {
			
			[# th:each="infoInit : ${roomInfo}"]
				var roomInfoInit = [[${infoInit}]];
				roomInfo.push(roomInfoInit);	
			[/]
			
			playerInfo = {
				x: [[${pos[0]}]],
				y: [[${pos[1]}]],
				width: 60,
				height: 60,
				moveBox: {
					x: 0,
					y: 0,
					width: 40,
					height: 40
				},
				hitBox: {
					x: 0,
					y: 0,
					width: 40,
					height: 50
				},
				invincibleFlag: false,
				coin: [[${playerInfo.coin}]],
				bomb: [[${playerInfo.bomb}]],
				key: [[${playerInfo.key}]],
				weapon: [[${playerInfo.weapon}]],
				item: [[${playerInfo.item}]],
				status: {
					life: [[${playerInfo.status.life}]],
					maxLife: [[${playerInfo.status.maxLife}]],
					eLife: [[${playerInfo.status.eLife}]],
					damage: [[${playerInfo.status.damage}]],
					speed: [[${playerInfo.status.speed}]],
					range: [[${playerInfo.status.range}]]
				},
				setBoxes: function() {
					this.moveBox.x = this.x + 20;
					this.moveBox.y = this.y + 40;
					this.hitBox.x = this.x + 20;
					this.hitBox.y = this.y + 30;
				},
				damaged: function(dmg) {
					if(!this.invincibleFlag) {
						if(this.status.eLife > 0) {
							this.status.eLife -= dmg;
						} else {
							this.status.life -= dmg;
						}
						this.invincibleFlag = true;
						
						if(this.status.life <= 0) {
							console.log("Gamjeon died");
							clearInterval(drawInterval);
						} else {
							setTimeout(function() {
								playerInfo.invincibleFlag = false;
							}, 2000);
						}
					}
				}
			};
			
			playerInfo.setBoxes();
			doorSetting();
			obstacleSetting();
			setInterval(drawInfo, 20);
			drawInterval = setInterval(draw, 20);
		}
		
		function doorSetting() {
			var doors = roomInfo[roomNo].doors;
			
			for(var i = 0; i < doors.length; i++) {
				if(doors[i] == 0) {
					door[i] = null;
					continue;
				}
				
				var doorImg = document.createElement("img");
				doorImg.setAttribute("width", "60");
				doorImg.setAttribute("height", "60");
				
				if(doors[i] == 1) {
					doorImg.setAttribute("src", "img/sprite/room/door_closed.png");
					door[i] = doorImg;
				} else if(doors[i] == 2) {
					doorImg.setAttribute("src", "img/sprite/room/door_opened.png");
					door[i] = doorImg;
				}
			}
		}
		
		function obstacleSetting() {
			if(obstacle.length > 0) {
				obstacle.splice(0, obstacle.length);
			}
			
			var obstacles = roomInfo[roomNo].obstacles;
			
			for(var i = 0; i < obstacles.length; i++) {
				var obstacleImg = document.createElement("img");
				obstacleImg.setAttribute("width", "60");
				obstacleImg.setAttribute("height", "60");
				
				switch(obstacles[i][2]) {
				case 1:
					obstacleImg.setAttribute("src", "img/sprite/room/stone.png");
					break;
				case 2:
					obstacleImg.setAttribute("src", "img/sprite/room/pit_edge.png");
					break;
				case 3:
					obstacleImg.setAttribute("src", "img/sprite/room/stone_was_here.png");
					break;
				}

				obstacle.push(obstacleImg);
			}
		}
		
		function monsterSetting() {
			if(monster.length > 0) {
				monster.splice(0, monster.length);
			}
			
			var monsters = roomInfo[roomNo].monsters;
			
			if(monsters == null) { // no monster room
				return;
			}
			
			for(var i = 0; i < monsters.length; i++) {
				if(monsters[i][0] == 0) { // dead monster
					continue;
				}
				var m = monsterInit(monsters[i][0], monsters[i][1], monsters[i][2]);

				monster.push(m);
			}
		}
		
		function attackSetting(dir) {
			if(attackFlag) {
				attackFlag = false;
				
				attackDirection = dir;
				
				var mx = 0;
				var my = 0;
				var md = 10;
				switch(dir) {
				case 0:
					my = -md;
					break;
				case 1:
					my = md;
					break;
				case 2:
					mx = -md;
					break;
				case 3:
					mx = md;
					break;
				}
				var attackObj = {
					mx: mx,
					my: my,
					dir: dir,
					x: playerInfo.x + 30,
					y: playerInfo.y + 30,
					rangeCount: 0,
					move: function() {
						this.x += this.mx;
						this.y += this.my;
						this.rangeCount++;
					},
					isValid: function() {
						if(monsterDamagedCheck(this.x, this.y)) {
							console.log("attack removed by monster");
							return false;
						} if(!obstacleAttackCheck(this.dir, this.x, this.y, 20)) {
							console.log("attack removed by obstacle");
							return false;
						} else if(this.x < wall[2] || this.x > cw - wall[3]) {
							console.log("attack removed by wall left or wall right");
							return false;
						} else if(this.y < wall[0] || this.y > ch - wall[1]) {
							console.log("attack removed by wall top or wall bottom");
							return false;
						} else if(this.rangeCount == playerInfo.status.range) {
							console.log("attack removed because of range limit");
							return false;
						} else {
							return true;
						}
					}
				};
				attacks.push(attackObj);
				
				setTimeout(function() {
					attackFlag = true;	
				}, 250);
			}
		}
		
		function bombSetting(x, y) {
			if(bombFlag && playerInfo.bomb > 0) {
				bombFlag = false;
				playerInfo.bomb--;
				var bombInfoInit = {
					x: x,
					y: y,
					count: 0
				};
				bombInfo = bombInfoInit;
				console.log("bomb start");
			}
		}
		
		function playerMove() {
			var x = playerInfo.moveBox.x;
			var y = playerInfo.moveBox.y;
			if(pressed[0] && (playerInfo.moveBox.y > wall[0]) && obstacleCheck(0, playerInfo)) {
				playerInfo.y -= playerInfo.status.speed;
				playerInfo.setBoxes();
			}
			if(pressed[1] && (playerInfo.moveBox.y < ch-(wall[1]+40)) && obstacleCheck(1, playerInfo)) {
				playerInfo.y += playerInfo.status.speed;
				playerInfo.setBoxes();
			}
			if(pressed[2] && (playerInfo.moveBox.x > wall[2]) && obstacleCheck(2, playerInfo)) {
				playerInfo.x -= playerInfo.status.speed;
				playerInfo.setBoxes();
			}
			if(pressed[3] && (playerInfo.moveBox.x < cw-(wall[3]+40)) && obstacleCheck(3, playerInfo)) {
				playerInfo.x += playerInfo.status.speed;
				playerInfo.setBoxes();
			}
		}
		
		function directionCheck() {
			if(pressed[0]) {
				directionCode = 0;
				if(pressed[3]) {
					directionCode = 1;
				} else if(pressed[2]) {
					directionCode = 5;
				}
			} else if(pressed[1]) {
				directionCode = 2;
				if(pressed[2]) {
					directionCode = 3;
				} else if(pressed[3]) {
					directionCode = 7;
				}
			} else if(pressed[2]) {
				directionCode = 4;
				if(pressed[0]) {
					directionCode = 5;
				} else if(pressed[1]) {
					directionCode = 3;
				}
			} else if(pressed[3]) {
				directionCode = 6;
				if(pressed[0]) {
					directionCode = 1;
				} else if(pressed[1]) {
					directionCode = 7;
				}
			}
		}
		
		function doorCheck() {
			if(playerInfo.moveBox.y <= 40) {
				moveRoom(0);
			} else if(playerInfo.moveBox.y >= (ch-(40+40))) {
				moveRoom(1);
			} else if(playerInfo.moveBox.x <= 40) {
				moveRoom(2);
			} else if(playerInfo.moveBox.x >= (cw-(40+40))) {
				moveRoom(3);
			}
		}
		
		function chestCheck() {
			var chest = roomInfo[roomNo].chest;
			if(chest == null) {
				return;
			}
			
			var cx = chest.x * 60 + 60;
			var cy = chest.y * 60 + 60;
			var vx = playerInfo.moveBox.x - cx;
			var vy = playerInfo.moveBox.y - cy;
			
			if(Math.abs(vx) < 50 && Math.abs(vy) < 50 && !chest.opened) {
				roomInfo[roomNo].chest.opened = true;
				var i = 0;
				var itemGet = setInterval(function() {
					ctx.drawImage(item, chest.itemCode*20, 0, 20, 20, cx + 20, cy - i * 10 + 20, 20, 20);
					i++;
					if(i == 8) {
						clearInterval(itemGet);
					}
				}, 40);
			}
		}
		
		function wallCheck() {
			var doors = roomInfo[roomNo].doors;
			
			var dx = cw/2 - 30;
			var dy = ch/2 - 30;
			
			if(playerInfo.moveBox.x >= dx && playerInfo.moveBox.x <= dx + 20 && playerInfo.moveBox.y < (ch/2-40) && doors[0] == 2) {
				wall[0] = 40;
				wall[1] = 60;
			} else if(playerInfo.moveBox.x >= dx && playerInfo.moveBox.x <= dx + 20 && doors[1] == 2) {
				wall[0] = 60;
				wall[1] = 40;
			} else {
				wall[0] = 60;
				wall[1] = 60;
			}
			if(playerInfo.moveBox.y >= dy && playerInfo.moveBox.y <= dy + 20 && playerInfo.moveBox.x < (cw/2-40) && doors[2] == 2) {
				wall[2] = 40;
				wall[3] = 60;
			} else if(playerInfo.moveBox.y >= dy && playerInfo.moveBox.y <= dy + 20 && doors[3] == 2) {
				wall[2] = 60;
				wall[3] = 40;
			} else {
				wall[2] = 60;
				wall[3] = 60;
			}
		}
		
		function obstacleCheck(dir, obj) { // obj must contain x, y, moveBox.x, moveBox.y, status.speed, setBoxes() 
			var mx = obj.moveBox.x + obj.moveBox.width/2;
			var my = obj.moveBox.y + obj.moveBox.height/2;
			var boundX = 30 + obj.moveBox.width/2;
			var boundY = 30 + obj.moveBox.height/2;
			var ox;
			var oy;
			var vx;
			var vy;
			for(var i = 0; i < obstacle.length; i++) {
				if(roomInfo[roomNo].obstacles[i][2] == 3) {
					continue;
				}
				ox = roomInfo[roomNo].obstacles[i][0] * 60 + 60 + 30;
				oy = roomInfo[roomNo].obstacles[i][1] * 60 + 60 + 30;

				vx = mx - ox;
				vy = my - oy;
				
				if(Math.abs(vx) <= boundX && Math.abs(vy) <= boundY) {
					switch(dir) {
					case 0:
						if(my > oy && mx > ox - boundX && mx < ox + boundX) {
							return false;
						}
						break;
					case 1:
						if(my < oy && mx > ox - boundX && mx < ox + boundX) {
							return false;
						}
						break;
					case 2:
						if(mx > ox && my > oy - boundY && my < oy + boundY) {
							return false;
						}
						break;
					case 3:
						if(mx < ox && my > oy - boundY && my < oy + boundY) {
							return false;
						}
						break;
					}
				}
			}
			return true;
		}
		
		function obstacleAttackCheck(dir, x, y, size) {
			var mx = x + size/2;
			var my = y + size/2;
			var boundX = 30 + size/2;
			var boundY = 30 + size/2;
			var ox;
			var oy;
			var vx;
			var vy;
			for(var i = 0; i < obstacle.length; i++) {
				if(roomInfo[roomNo].obstacles[i][2] != 1) {
					continue;
				}
				ox = roomInfo[roomNo].obstacles[i][0] * 60 + 60 + 30;
				oy = roomInfo[roomNo].obstacles[i][1] * 60 + 60 + 30;
				vx = mx - ox;
				vy = my - oy;
				
				if(Math.abs(vx) < boundX && Math.abs(vy) < boundY) {
					return false;
				}
			}
			return true;
		}
		
		function obstacleDestroyCheck() {
			var mx = bombInfo.x + bomb.width/2;
			var my = bombInfo.y + bomb.height/2;
			var ox;
			var oy;
			for(var i = 0; i < obstacle.length; i++) {
				if(roomInfo[roomNo].obstacles[i][2] != 1) {
					continue;
				}
				ox = roomInfo[roomNo].obstacles[i][0] * 60 + 60 + 30;
				oy = roomInfo[roomNo].obstacles[i][1] * 60 + 60 + 30;
				
				if(Math.abs(mx-ox) < (bomb.width + 60)/2 && Math.abs(my-oy) < (bomb.height + 60)/2) {
					roomInfo[roomNo].obstacles[i][2] = 3;
					obstacle[i].src = "img/sprite/room/stone_was_here.png";
				}
				
			}
		}
		
		function playerCollisionCheck(m) {
			var vx = (playerInfo.hitBox.x + playerInfo.hitBox.width/2) - (m.hitBox.x + m.hitBox.width/2);
			var vy = (playerInfo.hitBox.y + playerInfo.hitBox.height/2) - (m.hitBox.y + m.hitBox.height/2);
			var boundX = (playerInfo.hitBox.width + m.hitBox.width)/2;
			var boundY = (playerInfo.hitBox.height + m.hitBox.height)/2;
			
			if(Math.abs(vx) < boundX && Math.abs(vy) < boundY) {
				playerInfo.damaged(m.status.damage);
			}
		}
		
		function monsterDamagedCheck(bx, by) {
			var vx;
			var vy;
			var boundX;
			var boundY;
			
			for(var i = 0; i < monster.length; i++) {
				vx = monster[i].moveBox.x - bx;
				vy = monster[i].moveBox.y - by;
				boundX = monster[i].moveBox.width/2 + 10;
				boundY = monster[i].moveBox.height/2 + 10;
				
				if(Math.abs(vx) < boundX && Math.abs(vy) < boundY) {
					monster[i].damaged(playerInfo.status.damage);
					console.log("monster damaged");
					return true;
				}
			}
			return false;
		}
		
		function drawImage() {
			ctx.drawImage(room, 0, 0);
			
			drawDoor();
			
			if(roomNo == 0) {
				ctx.drawImage(floor, 60, 60);
			} else {
				ctx.fillStyle = '#C3C3C3';
				ctx.fillRect(60, 60, floor.width, floor.height);
			}
			
			drawChestAndObstacle();
			
			if(!bombFlag) {
				drawBomb();
			}
			
			var bodyCrop = Math.floor(directionCode/2);
			if(playerInfo.invincibleFlag) {
				ctx.globalAlpha = 0.5;
				ctx.drawImage(player, bodyCrop * 80, 80, 80, 80, playerInfo.x, playerInfo.y, 80, 80);
				ctx.drawImage(player, attackDirection * 80, 0, 80, 80, playerInfo.x, playerInfo.y, 80, 80);
				ctx.globalAlpha = 1;
			} else {
				ctx.drawImage(player, bodyCrop * 80, 80, 80, 80, playerInfo.x, playerInfo.y, 80, 80);
				ctx.drawImage(player, attackDirection * 80, 0, 80, 80, playerInfo.x, playerInfo.y, 80, 80);
			}
		}
		
		function drawAttack() {
			var remove = [];
			for(var i = 0; i < attacks.length; i++) {
				if(attacks[i].isValid()) {
					attacks[i].move();
					ctx.drawImage(attack, attacks[i].x, attacks[i].y);
				} else {
					remove.push(i);
				}
			}
			for(var i = remove.length; i > 0; i--) {
				attacks.splice(remove[i-1], 1);
			}
		}
		
		function drawDoor() {
			for(var i = 0; i < door.length; i++) {
				if(door[i]==null) {
					continue;
				}
				
				var dx;
				var dy;
				var deg;
				
				switch(i) {
				case 0:
					dx = cw/2 - 30; dy = 0;
					deg = 0;
					break;
				case 1:
					dx = cw/2 - 30; dy = ch - 60;
					deg = 180;
					break;
				case 2:
					dx = 0; dy = ch/2 - 30;
					deg = 270;
					break;
				case 3:
					dx = cw - 60; dy = ch/2 - 30;
					deg = 90;
					break;
				}
				ctx.save();
				ctx.translate(dx+0.5*door[i].width, dy+0.5*door[i].height);
				ctx.rotate(deg * Math.PI / 180);
				ctx.translate(-(dx+0.5*door[i].width), -(dy+0.5*door[i].height));
				ctx.drawImage(door[i], dx, dy);
				ctx.restore();
			}
		}
		
		function drawChestAndObstacle() {
			var chest = roomInfo[roomNo].chest;
			if(chest != null) {
				var chestImg = document.createElement("img");
				chestImg.setAttribute("width", "60");
				chestImg.setAttribute("height", "60");
				if(!chest.opened && !chest.locked) {
					chestImg.src = "img/sprite/chest_closed.png";
				} else if(chest.opened && !chest.locked) {
					chestImg.src = "img/sprite/chest_opened.png";
				}
				ctx.drawImage(chestImg, chest.x * 60 + 60, chest.y * 60 + 60);
			}
			for(var i = 0; i < obstacle.length; i++) {
				ctx.drawImage(obstacle[i], roomInfo[roomNo].obstacles[i][0] * 60 + 60, roomInfo[roomNo].obstacles[i][1] * 60 + 60);
			}
		}
		
		function drawBomb() {
			var bombCropX;
			var bombCropY;
			var width;
			var height;
			if(bombInfo.count < 50 && bombInfo.count%5 == 0 && bombInfo.count%10 == 0) {
				bombCropX = 0;
				bombCropY = 0;
				width = 40;
				height = 40;
			} else if(bombInfo.count < 50 && bombInfo.count%5 == 0 && bombInfo.count%10 != 0) {
				bombCropX = 40;
				bombCropY = 0;
				width = 40;
				height = 40;
			} else if(bombInfo.count == 50) {
				bombCropX = 0;
				bombCropY = 40;
				width = 160;
				height = 160;
				bombInfo.x -= 60;
				bombInfo.y -= 60;
				obstacleDestroyCheck();
			} else if(bombInfo.count == 55) {
				bombCropX = 0;
				bombCropY = 200;
				width = 160;
				height = 160;
			} else if(bombInfo.count == 60) {
				bombFlag = true;
				console.log("bomb end");
				return;
			}
			
			ctx.drawImage(bomb, bombCropX, bombCropY, width, height, bombInfo.x, bombInfo.y, width, height);
			
			bombInfo.count++;
		}
		
		function moveRoom(dir) {
			controlFlag = false;
			clearInterval(drawInterval);
			
			var rx;
			var ry;
			var x = 0;
			var y = 0;
			
			var sliceX;
			var sliceY;
			var change;
			
			roomNo = roomInfo[roomNo].linked[dir];
			
			var doors = roomInfo[roomNo].doors;
			var linked = roomInfo[roomNo].linked;
			
			roomInfo[roomNo].visited = 2;
			for(var i = 0; i < linked.length; i++) {
				if(doors[i]==0) {
					continue;
				}
				if(roomInfo[linked[i]].visited==0) {
					roomInfo[linked[i]].visited = 1;
				}
			}
			doorSetting();
			obstacleSetting();
			monsterSetting();
			
			switch(dir) {
			case 0:
				sliceX = 0; sliceY = 20;
				rx = 0; ry = -ch;
				playerInfo.x = cw/2 - 40; playerInfo.y = ch - 140;
				break;
			case 1:
				sliceX = 0; sliceY = -20;
				rx = 0; ry = ch;
				playerInfo.x = cw/2 + 40; playerInfo.y = 60;
				break;
			case 2:
				sliceX = 20; sliceY = 0;
				rx = -cw; ry = 0;
				playerInfo.x = cw - 140; playerInfo.y = ch/2 - 40;
				break;
			case 3:
				sliceX = -20; sliceY = 0;
				rx = cw; ry = 0;
				playerInfo.x = 60; playerInfo.y = playerInfo.y = ch/2 - 40;
				break;
			}
			
			playerInfo.setBoxes();
			
			ctx.fillStyle = '#C3C3C3';
			
			var interval = setInterval(function() {
				ctx.clearRect(0, 0, cw, ch);
				
				x += sliceX; y += sliceY;
				rx += sliceX; ry += sliceY;
				
				ctx.drawImage(room, x, y);
				ctx.fillRect(x + 60, y + 60, floor.width, floor.height);
				ctx.drawImage(room, rx, ry);
				ctx.fillRect(rx + 60, ry + 60, floor.width, floor.height);
				
				if(rx == 0 && ry == 0) {
					clearInterval(interval);
					drawInterval = setInterval(draw, 20);
					controlFlag = true;
				}
			}, 20);
		}
		
		function drawMonster() {
			for(var i = 0; i < monster.length; i++) {
				if(monster[i].status.life <= 0) {
					roomInfo[roomNo].monsters[i][0] = 0;
					continue;
				}
				monster[i].move(playerInfo.moveBox.x, playerInfo.moveBox.y);
				ctx.drawImage(monster[i].img, monster[i].x, monster[i].y);
				playerCollisionCheck(monster[i]);
			}
		}
		
		function draw() {
			ctx.clearRect(0, 0, cw, ch);
			
			drawImage();
			
			directionCheck();
			
			drawAttack();
			
			drawMonster();
			
			wallCheck();
			
			playerMove();
			
			doorCheck();
			
			chestCheck();
		}
		
		function drawInfo() {
			var inventory = document.getElementById("info_inventory");
			var count;
			var life = playerInfo.status.life;
			var eLife = playerInfo.status.eLife;
			
			ctx2.clearRect(0, 0, infoCanvas.width, infoCanvas.height);
			
			ctx2.font = "20px Arial";
			
			for(var j = 0; j < roomInfo.length; j++) {
				if(roomInfo[j].visited==0) {
					continue;
				} else if(roomInfo[j].visited==1) {
					ctx2.fillStyle = "#585858";
				} else if(j == roomNo) {
					ctx2.fillStyle = "#FFFFFF";			
				} else {
					ctx2.fillStyle = "#C3C3C3";
				}
				ctx2.fillRect(22 * roomInfo[j].map[1] + 6, 17 * roomInfo[j].map[0] + 3, 20, 15);
			}
			ctx2.fillStyle = "#000000";
			
			ctx2.drawImage(item, 60, 0, 20, 20, 165, 5, 20, 20);
			count = playerInfo.coin;
			if(count<10) {
				count = "0"+count;
			}
			ctx2.fillText("x " + count, 195, 20);
			
			ctx2.drawImage(item, 40, 0, 20, 20, 165, 30, 20, 20);
			count = playerInfo.bomb;
			if(count<10) {
				count = "0"+count;
			}
			ctx2.fillText("x " + count, 195, 46);
			
			ctx2.drawImage(item, 80, 0, 20, 20, 165, 55, 20, 20);
			count = playerInfo.key;
			if(count<10) {
				count = "0"+count;
			}
			ctx2.fillText("x " + count, 195, 73);
			
			ctx2.drawImage(inventory, 255, 5);
			
			ctx2.fillText("LIFE", 430, 25);
			
			var vGap = 0;
			var hGap = 0;
			while(life>0) {
				if(vGap > 1) {
					break;
				}
				if(life>1) {
					ctx2.drawImage(item, 0, 0, 20, 20, 25*hGap + 380, 30 + 25*vGap, 20, 20);
					life -= 2;
				} else {
					ctx2.drawImage(item, 20, 0, 20, 20, 25*hGap + 380, 30 + 25*vGap, 20, 20);
					life--;
				}
				hGap++;
				if(hGap==6) {
					vGap = 1;
					hGap = 0;
				}
			}
			while(eLife>0) {
				if(vGap > 1) {
					break;
				}
				if(eLife>1) {
					ctx2.drawImage(item, 100, 0, 20, 20, 25*hGap + 380, 30 + 25*vGap, 20, 20);
					eLife -= 2;
				} else {
					ctx2.drawImage(item, 120, 0, 20, 20, 25*hGap + 380, 30 + 25*vGap, 20, 20);
					eLife--;
				}
				hGap++;
				if(hGap==6) {
					vGap = 1;
					hGap = 0;
				}
			}
		}
		/*]]>*/
	</script>

</body>
</html>