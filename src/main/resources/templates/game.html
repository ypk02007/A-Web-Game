<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>The Binding of GAMJEON</title>

<link rel="stylesheet" type="text/css" href="css/common.css">

</head>
<body>

	<img id="info_heart" width="20" height="20" src="img/info/heart.png">
	<img id="info_heart_half" width="30" height="30" src="img/info/heart_half.png">
	<img id="info_coin" width="20" height="20" src="img/info/coin.png">
	<img id="info_bomb" width="20" height="20" src="img/info/bomb.png">
	<img id="info_key" width="20" height="20" src="img/info/key.png">
	<img id="info_inventory" width="105" height="70" src="img/info/inventory.png">

	<img id="room" width="540" height="420" src="img/bg/room/room.png">
	<img id="floor" width="420" height="300" src="img/bg/room/control_description.png">
	<img id="phead" width="80" height="80" src="img/character/gamjeon_head_front.png">
	<img id="pbody" width="80" height="80" src="img/character/gamjeon_body_front.png">
	<img id="attack" width="20" height="20" src="img/character/weapon/default.png">
	
	<canvas id="info" width="540" height="80"></canvas>
	<canvas id="canvas" width="540" height="420"></canvas>
	
	<script th:inline="javascript">
		/*<![CDATA[*/
		var canvas = document.getElementById("canvas");
		var infoCanvas = document.getElementById("info");
		var ctx = canvas.getContext("2d");
		var ctx2 = infoCanvas.getContext("2d");
		const cw = canvas.width;
		const ch = canvas.height;

		var room = document.getElementById("room");
		var door = [null, null, null, null];
		var floor = document.getElementById("floor");
		var phead = document.getElementById("phead");
		var pbody = document.getElementById("pbody");
		var attack = document.getElementById("attack");
		
		var roomInfo = [];
		var roomNo;
		var playerInfo;
		var drawInterval;
		
		var wall = [10, 60, 40, 40]; // top, bottom, left, right
		var attacks = [];
		
		var pressed = [false, false, false, false]; // up, down, left, right
		
		var directionCode = 4;
		var attackDirection = 2;
		
		var controlFlag = true;
		var attackFlag = true;
		
		var roomNo = 0;
		
		document.addEventListener("keydown", keyDown, false);
		document.addEventListener("keyup", keyUp, false);
		
		window.onload = function() {
			init();
		};
		
		function init() {
			
			[# th:each="infoInit : ${roomInfo}"]
				var roomInfoInit = {
					doors: [[${infoInit.doors}]],
					linked: [[${infoInit.linked}]],
					visited: [[${infoInit.visited}]],
					map: [[${infoInit.map}]]
				};
				roomInfo.push(roomInfoInit);	
			[/]
			
			playerInfo = {
				x: [[${pos[0]}]],
				y: [[${pos[1]}]],
				moveBox: {
					x: 0,
					y: 0,
					size: 40
				},
				coin: [[${playerInfo.coin}]],
				bomb: [[${playerInfo.bomb}]],
				key: [[${playerInfo.key}]],
				weapon: [[${playerInfo.weapon}]],
				item: [[${playerInfo.item}]],
				status: {
					life: [[${playerInfo.status.life}]],
					maxLife: [[${playerInfo.status.maxLife}]],
					damage: [[${playerInfo.status.damage}]],
					speed: [[${playerInfo.status.speed}]],
					range: [[${playerInfo.status.range}]]
				},
				setBoxes: function() {
					this.moveBox.x = this.x + 20;
					this.moveBox.y = this.y + 40;
				}
			};
			doorSetting();
			setInterval(drawInfo, 20);
			drawInterval = setInterval(draw, 20);
		}
		
		function doorSetting() {
			var doors = roomInfo[roomNo].doors;
			
			for(var i = 0; i < doors.length; i++) {
				if(doors[i] == 0) {
					door[i] = null;
					continue;
				}
				
				var doorImg = document.createElement("img");
				doorImg.setAttribute("width", "60");
				doorImg.setAttribute("height", "60");
				
				if(doors[i] == 1) {
					doorImg.setAttribute("src", "img/bg/room/door_closed.png");
					door[i] = doorImg;
				} else if(doors[i] == 2) {
					doorImg.setAttribute("src", "img/bg/room/door_opened.png");
					door[i] = doorImg;
				}
			}
		}
		
		function keyDown(e) {
			var key = e.keyCode;
			
			if(!controlFlag) {
				return;
			}
			
			if(key==87) {
				pressed[0] = true;
			} else if(key==83) {
				pressed[1] = true;
			}
			
			if(key==65) {
				pressed[2] = true;
			} else if(key==68) {
				pressed[3] = true;
			}
			
			if(key==38) {
				attackSetting(1);
			}
			if(key==40) {
				attackSetting(2);
			}
			if(key==37) {
				attackSetting(3);
			}
			if(key==39) {
				attackSetting(4);
			}
		}
		
		function attackSetting(dir) {
			if(attackFlag) {
				attackFlag = false;
				
				var mx = 0;
				var my = 0;
				var md = 10;
				switch(dir) {
				case 1:
					my = -md;
					break;
				case 2:
					my = md;
					break;
				case 3:
					mx = -md;
					break;
				case 4:
					mx = md;
					break;
				}
				var attackObj = {
					mx: mx,
					my: my,
					x: playerInfo.x + 30,
					y: playerInfo.y + 30,
					rangeCount: 0,
					move: function() {
						this.x += this.mx;
						this.y += this.my;
						this.rangeCount++;
					},
					isValid: function() {
						if(this.x < wall[2] || this.x > cw - wall[3]) {
							console.log("attack removed by wall left or wall right");
							return false;
						} else if(this.y < wall[0] || this.y > ch - wall[1]) {
							console.log("attack removed by wall top or wall bottom");
							return false;
						} else if(this.rangeCount == playerInfo.status.range) {
							console.log("attack removed because of range limit");
							return false;
						} else {
							return true;
						}
					}
				};
				attacks.push(attackObj);
				
				setTimeout(function() {
					attackFlag = true;	
				}, 250);
			}
		}

		function keyUp(e) {
			var key = e.keyCode;
			
			if(key==87) {
				pressed[0] = false;
			} else if(key==83) {
				pressed[1] = false;
			}
			
			if(key==65) {
				pressed[2] = false;
			} else if(key==68) {
				pressed[3] = false;
			}
		}
		
		function directionCheck() {
			if(pressed[0]) {
				directionCode = 0;
				if(pressed[3]) {
					directionCode = 1;
				} else if(pressed[2]) {
					directionCode = 7;
				}
			} else if(pressed[1]) {
				directionCode = 4;
				if(pressed[2]) {
					directionCode = 5;
				} else if(pressed[3]) {
					directionCode = 3;
				}
			} else if(pressed[2]) {
				directionCode = 6;
				if(pressed[0]) {
					directionCode = 7;
				} else if(pressed[1]) {
					directionCode = 5;
				}
			} else if(pressed[3]) {
				directionCode = 2;
				if(pressed[0]) {
					directionCode = 1;
				} else if(pressed[1]) {
					directionCode = 3;
				}
			}
		}
	
		function setPlayerBody() {
			var src;
			switch(directionCode) {
			case 0:
				src = "img/character/gamjeon_body_back.png";
				break;
			case 1:
				src = "img/character/gamjeon_body_back.png";
				break;
			case 2:
				src = "img/character/gamjeon_body_right.png";
				break;
			case 3:
				src = "img/character/gamjeon_body_right.png";
				break;
			case 4:
				src = "img/character/gamjeon_body_front.png";
				break;
			case 5:
				src = "img/character/gamjeon_body_front.png";
				break;
			case 6:
				src = "img/character/gamjeon_body_left.png";
				break;
			case 7:
				src = "img/character/gamjeon_body_left.png";
				break;
			default:
				src	= "img/character/gamjeon_lying.png"
			}
			return src;
		}
		
		function setPlayerHead() {
			var src;
			switch(attackDirection) {
			case 1:
				src = "img/character/gamjeon_head_back.png";
				break;
			case 2:
				src = "img/character/gamjeon_head_front.png";
				break;
			case 3:
				src = "img/character/gamjeon_head_left.png";
				break;
			case 4:
				src = "img/character/gamjeon_head_right.png";
				break;
			}
			return src;
		}
		
		function drawAttack() {
			var remove = [];
			for(var i = 0; i < attacks.length; i++) {
				if(attacks[i].isValid()) {
					attacks[i].move();
					ctx.drawImage(attack, attacks[i].x, attacks[i].y);
				} else {
					remove.push(i);
				}
			}
			for(var i = remove.length; i > 0; i--) {
				attacks.splice(remove[i-1], 1);
			}
		}
		
		function playerMove() {
			if(pressed[0] && (playerInfo.y > wall[0])) {
				playerInfo.y -= playerInfo.status.speed;
				playerInfo.setBoxes();
			}
			if(pressed[1] && (playerInfo.y < ch-(wall[1]+pbody.height))) {
				playerInfo.y += playerInfo.status.speed;
				playerInfo.setBoxes();
			}
			if(pressed[2] && (playerInfo.x > wall[2])) {
				playerInfo.x -= playerInfo.status.speed;
				playerInfo.setBoxes();
			}
			if(pressed[3] && (playerInfo.x < cw-(wall[3]+pbody.width))) {
				playerInfo.x += playerInfo.status.speed;
				playerInfo.setBoxes();
			}
		}
		
		function wallCheck() {
			var doors = roomInfo[roomNo].doors;
			
			var dx = cw/2 - 30;
			var dy = ch/2 - 30;
			
			if(playerInfo.moveBox.x >= dx && playerInfo.moveBox.x <= dx + 20 && playerInfo.moveBox.y < (ch/2-pbody.height/2) && doors[0] == 2) {
				wall[0] = -10;
				wall[1] = 60;
			} else if(playerInfo.moveBox.x >= dx && playerInfo.moveBox.x <= dx + 20 && doors[1] == 2) {
				wall[0] = 10;
				wall[1] = 40;
			} else {
				wall[0] = 10;
				wall[1] = 60;
			}
			if(playerInfo.moveBox.y >= dy && playerInfo.moveBox.y <= dy + 20 && playerInfo.moveBox.x < (cw/2-pbody.width/2) && doors[2] == 2) {
				wall[2] = 20;
				wall[3] = 40;
			} else if(playerInfo.moveBox.y >= dy && playerInfo.moveBox.y <= dy + 20 && doors[3] == 2) {
				wall[2] = 40;
				wall[3] = 20;
			} else {
				wall[2] = 40;
				wall[3] = 40;
			}
		}
		
		function drawImage() {
			pbody.src = setPlayerBody();
			phead.src = setPlayerHead();

			ctx.drawImage(room, 0, 0);
			drawDoor();
			if(roomNo == 0) {
				ctx.drawImage(floor, 60, 60);
			} else {
				ctx.fillStyle = '#C3C3C3';
				ctx.fillRect(60, 60, floor.width, floor.height);
			}
			ctx.drawImage(pbody, playerInfo.x, playerInfo.y);
			ctx.drawImage(phead, playerInfo.x, playerInfo.y);
		}
		
		function drawDoor() {
			for(var i = 0; i < door.length; i++) {
				if(door[i]==null) {
					continue;
				}
				
				var dx;
				var dy;
				var deg;
				
				switch(i) {
				case 0:
					dx = cw/2 - 30; dy = 0;
					deg = 0;
					break;
				case 1:
					dx = cw/2 - 30; dy = ch - 60;
					deg = 180;
					break;
				case 2:
					dx = 0; dy = ch/2 - 30;
					deg = 270;
					break;
				case 3:
					dx = cw - 60; dy = ch/2 - 30;
					deg = 90;
					break;
				}
				ctx.save();
				ctx.translate(dx+0.5*door[i].width, dy+0.5*door[i].height);
				ctx.rotate(deg * Math.PI / 180);
				ctx.translate(-(dx+0.5*door[i].width), -(dy+0.5*door[i].height));
				ctx.drawImage(door[i], dx, dy);
				ctx.restore();
			}
		}
		
		function doorCheck() {
			if(playerInfo.y == -10) {
				moveRoom(0);
			} else if(playerInfo.y == (ch-(pbody.height+40))) {
				moveRoom(1);
			} else if(playerInfo.x == 20) {
				moveRoom(2);
			} else if(playerInfo.x == (cw-(pbody.width+20))) {
				moveRoom(3);
			}
		}
		
		function moveRoom(dir) {
			controlFlag = false;
			clearInterval(drawInterval);
			
			var rx;
			var ry;
			var x = 0;
			var y = 0;
			
			var sliceX;
			var sliceY;
			var change;
			
			roomNo = roomInfo[roomNo].linked[dir];
			
			var doors = roomInfo[roomNo].doors;
			var linked = roomInfo[roomNo].linked;
			
			roomInfo[roomNo].visited = 2;
			for(var i = 0; i < linked.length; i++) {
				if(doors[i]==0) {
					continue;
				}
				if(roomInfo[linked[i]].visited==0) {
					roomInfo[linked[i]].visited = 1;
				}
			}
			doorSetting();
			
			switch(dir) {
			case 0:
				sliceX = 0; sliceY = 20;
				rx = 0; ry = -ch;
				playerInfo.x = cw/2 - pbody.width/2; playerInfo.y = ch - (60 + pbody.height);
				break;
			case 1:
				sliceX = 0; sliceY = -20;
				rx = 0; ry = ch;
				playerInfo.x = cw/2 + pbody.width/2; playerInfo.y = 60;
				break;
			case 2:
				sliceX = 20; sliceY = 0;
				rx = -cw; ry = 0;
				playerInfo.x = cw - (60 + pbody.width); playerInfo.y = ch/2 - pbody.height/2;
				break;
			case 3:
				sliceX = -20; sliceY = 0;
				rx = cw; ry = 0;
				playerInfo.x = 60; playerInfo.y = playerInfo.y = ch/2 - pbody.height/2;
				break;
			}
			
			ctx.fillStyle = '#C3C3C3';
			
			var interval = setInterval(function() {
				ctx.clearRect(0, 0, cw, ch);
				
				x += sliceX; y += sliceY;
				rx += sliceX; ry += sliceY;
				
				ctx.drawImage(room, x, y);
				ctx.fillRect(x + 60, y + 60, floor.width, floor.height);
				ctx.drawImage(room, rx, ry);
				ctx.fillRect(rx + 60, ry + 60, floor.width, floor.height);
				
				if(rx == 0 && ry == 0) {
					clearInterval(interval);
					drawInterval = setInterval(draw, 20);
					controlFlag = true;
				}
			}, 20);
		}
		
		function draw() {
			ctx.clearRect(0, 0, cw, ch);
			
			drawImage();
			
			directionCheck();
			
			if(attacks.length > 0) {
				drawAttack();
			}
			
			wallCheck();
			
			playerMove();
			
			doorCheck();
		}
		
		function drawInfo() {
			var coin = document.getElementById("info_coin");
			var bomb = document.getElementById("info_bomb");
			var key = document.getElementById("info_key");
			var inventory = document.getElementById("info_inventory");
			var heart = document.getElementById("info_heart");
			var heart_half = document.getElementById("info_heart_half");
			var count;
			var life = playerInfo.status.life;
			var i = 0;
			
			ctx2.clearRect(0, 0, infoCanvas.width, infoCanvas.height);
			
			ctx2.font = "20px Arial";
			
			for(var j = 0; j < roomInfo.length; j++) {
				if(roomInfo[j].visited==0) {
					continue;
				} else if(roomInfo[j].visited==1) {
					ctx2.fillStyle = "#585858";
				} else if(j == roomNo) {
					ctx2.fillStyle = "#FFFFFF";			
				} else {
					ctx2.fillStyle = "#C3C3C3";
				}
				ctx2.fillRect(22 * roomInfo[j].map[1] + 6, 17 * roomInfo[j].map[0] + 3, 20, 15);
			}
			ctx2.fillStyle = "#000000";
			
			ctx2.drawImage(coin, 165, 5);
			count = playerInfo.coin;
			if(count<10) {
				count = "0"+count;
			}
			ctx2.fillText("x " + count, 195, 20);
			
			ctx2.drawImage(bomb, 165, 30);
			count = playerInfo.bomb;
			if(count<10) {
				count = "0"+count;
			}
			ctx2.fillText("x " + count, 195, 46);
			
			ctx2.drawImage(key, 165, 55);
			count = playerInfo.key;
			if(count<10) {
				count = "0"+count;
			}
			ctx2.fillText("x " + count, 195, 73);
			
			ctx2.drawImage(inventory, 255, 5);
			
			while(life>0) {
				if(life>1) {
					ctx2.drawImage(heart, 25*i + 380, 30);
					life -= 2;
				} else {
					ctx2.drawImage(heart_half, 25*i + 380, 30);
					life--;
				}
				i++;
			}
		}
		/*]]>*/
	</script>

</body>
</html>